// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  password        String?
  firstName       String
  lastName        String
  phone           String?
  avatar          String?
  role            Role      @default(MEMBER)
  status          UserStatus @default(ACTIVE)
  emailVerified   Boolean   @default(false)
  phoneVerified   Boolean   @default(false)
  birthDate       DateTime?
  gender          Gender?
  maritalStatus   MaritalStatus?
  baptismDate     DateTime?
  membershipDate  DateTime?
  lastLogin       DateTime?
  address         Address?
  familyMembers   User[]    @relation("Family")
  familyHeadId    String?
  familyHead      User?     @relation("Family", fields: [familyHeadId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  prayerRequests  PrayerRequest[]
  donations       Donation[]
  eventRegistrations EventRegistration[]
  groupMembers    GroupMember[]
  servingRoles    ServingRole[]
  
  @@index([email])
  @@index([role])
  @@index([membershipDate])
}

model Address {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  street      String
  city        String
  state       String
  zipCode     String
  country     String   @default("US")
  coordinates String?  // For Google Maps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PrayerRequest {
  id          String         @id @default(cuid())
  userId      String
  user        User           @relation(fields: [userId], references: [id])
  title       String
  description String
  isAnonymous Boolean        @default(false)
  isPublic    Boolean        @default(false)
  status      PrayerStatus   @default(PENDING)
  category    PrayerCategory
  prayedBy    User[]         @relation("PrayedFor")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Event {
  id                String        @id @default(cuid())
  title             String
  description       String
  shortDescription  String?
  startDate         DateTime
  endDate           DateTime?
  location          String
  venue             String?
  isOnline          Boolean       @default(false)
  onlineLink        String?
  category          EventCategory
  image             String?
  maxAttendees      Int?
  isRegistrationRequired Boolean  @default(false)
  registrationDeadline DateTime?
  status            EventStatus   @default(UPCOMING)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Relations
  registrations     EventRegistration[]
  
  @@index([startDate])
  @@index([category])
  @@index([status])
}

model EventRegistration {
  id          String   @id @default(cuid())
  eventId     String
  event       Event    @relation(fields: [eventId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  status      RegistrationStatus @default(CONFIRMED)
  guests      Int      @default(0)
  notes       String?
  checkedIn   Boolean  @default(false)
  checkedInAt DateTime?
  createdAt   DateTime @default(now())
  
  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model Sermon {
  id            String      @id @default(cuid())
  title         String
  description   String
  preacher      String
  preacherId    String?
  preacherUser  User?       @relation(fields: [preacherId], references: [id])
  date          DateTime
  duration      Int         // in minutes
  series        String?
  biblePassage  String?
  videoUrl      String?
  audioUrl      String?
  thumbnail     String?
  transcript    String?
  views         Int         @default(0)
  downloads     Int         @default(0)
  likes         Int         @default(0)
  tags          String[]
  isLive        Boolean     @default(false)
  liveStreamId  String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@index([date])
  @@index([preacher])
  @@index([tags])
}

model Donation {
  id            String        @id @default(cuid())
  userId        String?
  user          User?         @relation(fields: [userId], references: [id])
  donorName     String
  donorEmail    String
  donorPhone    String?
  amount        Float
  currency      String        @default("USD")
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?
  receiptNumber String        @unique
  designation   DonationDesignation?
  frequency     DonationFrequency @default(ONE_TIME)
  notes         String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([transactionId])
}

model Group {
  id          String      @id @default(cuid())
  name        String
  description String
  type        GroupType
  leaderId    String
  leader      User        @relation(fields: [leaderId], references: [id])
  meetingDay  String?
  meetingTime String?
  location    String?
  isActive    Boolean     @default(true)
  maxMembers  Int?
  image       String?
  tags        String[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // Relations
  members     GroupMember[]
  
  @@index([type])
  @@index([leaderId])
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  group     Group    @relation(fields: [groupId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  role      GroupRole @default(MEMBER)
  joinedAt  DateTime @default(now())
  status    GroupMemberStatus @default(ACTIVE)
  
  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model Announcement {
  id          String            @id @default(cuid())
  title       String
  content     String
  authorId    String
  author      User              @relation(fields: [authorId], references: [id])
  priority    AnnouncementPriority @default(NORMAL)
  targetRoles Role[]
  targetGroups String[] // Group IDs
  isPublished Boolean           @default(false)
  publishAt   DateTime?
  expiresAt   DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([isPublished])
  @@index([publishAt])
}

model Media {
  id          String        @id @default(cuid())
  filename    String
  originalName String
  mimeType    String
  size        Int
  url         String
  thumbnail   String?
  width       Int?
  height      Int?
  duration    Int? // for videos
  category    MediaCategory
  tags        String[]
  uploadedById String
  uploadedBy  User          @relation(fields: [uploadedById], references: [id])
  isPublic    Boolean       @default(true)
  metadata    Json?
  createdAt   DateTime      @default(now())
  
  @@index([category])
  @@index([uploadedById])
  @@index([createdAt])
}

model VerificationToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String   // EMAIL_VERIFICATION, PASSWORD_RESET, etc.
  expires   DateTime
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([userId])
  @@index([expires])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expires   DateTime
  userAgent String?
  ipAddress String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([expires])
}

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  details   String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model SermonLike {
  id        String   @id @default(cuid())
  sermonId  String
  sermon    Sermon   @relation(fields: [sermonId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  
  @@unique([sermonId, userId])
  @@index([sermonId])
  @@index([userId])
}

model SermonView {
  id        String   @id @default(cuid())
  sermonId  String
  sermon    Sermon   @relation(fields: [sermonId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  viewedAt  DateTime @default(now())
  
  @@index([sermonId])
  @@index([userId])
  @@index([viewedAt])
}

model SermonDownload {
  id        String   @id @default(cuid())
  sermonId  String
  sermon    Sermon   @relation(fields: [sermonId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  type      String   // AUDIO, VIDEO, TRANSCRIPT
  createdAt DateTime @default(now())
  
  @@index([sermonId])
  @@index([userId])
  @@index([createdAt])
}

model PrayerRecord {
  id              String       @id @default(cuid())
  prayerRequestId String
  prayerRequest   PrayerRequest @relation(fields: [prayerRequestId], references: [id])
  userId          String
  user            User         @relation(fields: [userId], references: [id])
  notes           String?
  createdAt       DateTime     @default(now())
  
  @@unique([prayerRequestId, userId])
  @@index([prayerRequestId])
  @@index([userId])
  @@index([createdAt])
}

model ServingRole {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  ministryId String
  ministry  Ministry @relation(fields: [ministryId], references: [id])
  role      String
  startDate DateTime?
  endDate   DateTime?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([ministryId])
}

model Ministry {
  id          String   @id @default(cuid())
  name        String
  description String
  leaderId    String
  leader      User     @relation(fields: [leaderId], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([leaderId])
}

model StreamConfig {
  id                 String   @id @default(cuid())
  sermonId           String   @unique
  sermon             Sermon   @relation(fields: [sermonId], references: [id])
  allowChat          Boolean  @default(true)
  allowQuestions     Boolean  @default(true)
  moderateChat       Boolean  @default(false)
  requireApproval    Boolean  @default(false)
  autoRecord         Boolean  @default(true)
  enablePolls        Boolean  @default(true)
  enableReactions    Boolean  @default(true)
  chatSlowMode       Int      @default(0) // seconds between messages
  maxMessageLength   Int      @default(500)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model ChatMessage {
  id              String   @id @default(cuid())
  streamId        String
  sermon          Sermon   @relation(fields: [streamId], references: [id])
  userId          String?
  user            User?    @relation(fields: [userId], references: [id])
  message         String
  type            String   @default("message") // message, prayer, question, testimony
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, DELETED
  moderationReason String?
  metadata        Json?
  createdAt       DateTime @default(now())
  
  @@index([streamId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model StreamQuestion {
  id          String   @id @default(cuid())
  sermonId    String
  sermon      Sermon   @relation(fields: [sermonId], references: [id])
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  question    String
  isAnonymous Boolean  @default(false)
  status      String   @default("PENDING") // PENDING, ANSWERED, ARCHIVED
  answer      String?
  votes       Int      @default(0)
  createdAt   DateTime @default(now())
  
  @@index([sermonId])
  @@index([userId])
  @@index([status])
  @@index([votes])
  @@index([createdAt])
}

model Poll {
  id          String   @id @default(cuid())
  sermonId    String
  sermon      Sermon   @relation(fields: [sermonId], references: [id])
  question    String
  options     PollOption[]
  isActive    Boolean  @default(true)
  duration    Int?     // in seconds
  endedAt     DateTime?
  createdAt   DateTime @default(now())
  
  @@index([sermonId])
  @@index([isActive])
}

model PollOption {
  id        String   @id @default(cuid())
  pollId    String
  poll      Poll     @relation(fields: [pollId], references: [id])
  text      String
  order     Int
  votes     PollVote[]
  createdAt DateTime @default(now())
  
  @@index([pollId])
}

model PollVote {
  id        String   @id @default(cuid())
  pollId    String
  poll      Poll     @relation(fields: [pollId], references: [id])
  optionId  String
  option    PollOption @relation(fields: [optionId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  
  @@unique([pollId, userId])
  @@index([pollId])
  @@index([optionId])
  @@index([userId])
}

model StreamBan {
  id        String   @id @default(cuid())
  sermonId  String
  sermon    Sermon   @relation(fields: [sermonId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  reason    String
  duration  Int?     // in minutes, null for permanent
  bannedBy  String
  bannedByUser User  @relation("BannedBy", fields: [bannedBy], references: [id])
  expiresAt DateTime?
  createdAt DateTime @default(now())
  
  @@index([sermonId])
  @@index([userId])
  @@index([expiresAt])
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  firstName String
  lastName  String
  role      String
  token     String   @unique
  expires   DateTime
  invitedBy String
  invitedByUser User @relation(fields: [invitedBy], references: [id])
  accepted  Boolean  @default(false)
  acceptedAt DateTime?
  createdAt DateTime @default(now())
  
  @@index([email])
  @@index([token])
  @@index([expires])
}

model Newsletter {
  id           String   @id @default(cuid())
  subject      String
  content      String
  target       String   // ALL, MEMBERS, GUESTS, SPECIFIC
  targetUsers  String[]
  scheduleFor  DateTime?
  status       String   @default("DRAFT") // DRAFT, SCHEDULED, SENDING, SENT, FAILED
  sentAt       DateTime?
  sentCount    Int      @default(0)
  deliveredCount Int    @default(0)
  openedCount  Int      @default(0)
  clickedCount Int      @default(0)
  bouncedCount Int      @default(0)
  spamReportCount Int   @default(0)
  unsubscribedCount Int @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([status])
  @@index([scheduleFor])
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String   @default("general")
  updatedAt DateTime @updatedAt
  updatedBy String?
  updatedByUser User? @relation(fields: [updatedBy], references: [id])
  
  @@index([key])
  @@index([category])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  subject   String
  content   String
  variables String[] // Available template variables
  category  String   @default("general")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([name])
  @@index([category])
}

model Backup {
  id              String   @id @default(cuid())
  backupId        String   @unique
  type            String   // FULL, INCREMENTAL
  status          String   // PENDING, PROCESSING, COMPLETED, FAILED
  size            Int      // in bytes
  location        String   // S3 path or local path
  createdBy       String
  createdByUser   User     @relation(fields: [createdBy], references: [id])
  lastRestoredAt  DateTime?
  lastRestoredBy  String?
  lastRestoredByUser User? @relation("RestoredBy", fields: [lastRestoredBy], references: [id])
  createdAt       DateTime @default(now())
  
  @@index([backupId])
  @@index([status])
  @@index([createdAt])
}

model AccessLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  method    String
  url       String
  status    Int
  duration  Int      // in milliseconds
  ip        String?
  userAgent String?
  timestamp DateTime @default(now())
  
  @@index([userId])
  @@index([method])
  @@index([url])
  @@index([status])
  @@index([timestamp])
}

model ErrorLog {
  id        String   @id @default(cuid())
  level     String   // error, warn, info, debug
  message   String
  stack     String?
  metadata  Json?
  ip        String?
  userAgent String?
  timestamp DateTime @default(now())
  
  @@index([level])
  @@index([timestamp])
}

model CalendarSubscription {
  id        String   @id @default(cuid())
  channelId String   @unique
  resourceId String
  expiration DateTime
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  
  @@index([channelId])
  @@index([expiration])
}

model EmailEvent {
  id        String   @id @default(cuid())
  emailId   String
  event     String   // delivered, open, click, bounce, spamreport, unsubscribe
  recipient String
  metadata  Json?
  timestamp DateTime
  createdAt DateTime @default(now())
  
  @@index([emailId])
  @@index([event])
  @@index([recipient])
  @@index([timestamp])
}

model Integration {
  id        String   @id @default(cuid())
  name      String
  type      String   // SLACK, DISCORD, ZAPIER, MAKE, etc.
  config    Json
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([type])
  @@index([isActive])
}

model WebhookConfig {
  id        String   @id @default(cuid())
  integrationId String
  integration Integration @relation(fields: [integrationId], references: [id])
  url       String
  secret    String?
  events    String[]
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([integrationId])
  @@index([isActive])
}

model WebhookLog {
  id            String   @id @default(cuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id])
  payload       String
  status        String   // PENDING, PROCESSED, FAILED
  error         String?
  response      String?
  createdAt     DateTime @default(now())
  
  @@index([integrationId])
  @@index([status])
  @@index([createdAt])
}

// Enums
enum Role {
  SUPER_ADMIN
  ADMIN
  PASTOR
  LEADER
  MEMBER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum PrayerStatus {
  PENDING
  PRAYED
  ANSWERED
}

enum PrayerCategory {
  HEALING
  FINANCIAL
  RELATIONSHIP
  GUIDANCE
  THANKSGIVING
  OTHER
}

enum EventCategory {
  WORSHIP
  BIBLE_STUDY
  FELLOWSHIP
  OUTREACH
  YOUTH
  CHILDREN
  MEN
  WOMEN
  SPECIAL
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
}

enum RegistrationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  WAITLIST
}

enum PaymentMethod {
  STRIPE
  PAYPAL
  CASH
  CHECK
  BANK_TRANSFER
  MOBILE_MONEY
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum DonationDesignation {
  GENERAL
  MISSIONS
  BUILDING
  BENEvolENCE
  YOUTH
  MEDIA
  SPECIFIED
}

enum DonationFrequency {
  ONE_TIME
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum GroupType {
  SMALL_GROUP
  MINISTRY
  SERVICE_TEAM
  COMMITTEE
  CLASS
}

enum GroupRole {
  LEADER
  ASSISTANT
  MEMBER
  GUEST
}

enum GroupMemberStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum MediaCategory {
  SERMON
  EVENT
  PROFILE
  DOCUMENT
  GALLERY
  LIVE_STREAM
}